<% include layout/header %>
<style>
    .qution{
        margin-bottom: 2rem;
        padding: 20px;
        border-radius:20px;
        background-color:rgb(255, 255, 255);
        border: 1px solid rgb(194, 190, 190);
    }
    .qution:hover {
        box-shadow: 0px 0px 10px rgb(180, 198, 235);
        border: 1px solid rgba(93, 143, 246, 1);
        z-index: 2;
        -webkit-transition: all 200ms ease-in;
        -webkit-transform: scale(1.005);
        -ms-transition: all 200ms ease-in;
        -ms-transform: scale(1.005);
        -moz-transition: all 200ms ease-in;
        -moz-transform: scale(1.005);
        transition: all 200ms ease-in;
        transform: scale(1.005);
    }
</style>
<%if(isSubmited){%>
<h4>考卷名稱:
    <%=test.testName%>(已提交過此測驗)
</h4>
<%}else{%>
<h4>考卷名稱:
    <%=test.testName%>
</h4>
<%}%>

<hr>

<div class="col-md-12">
    <%let i = 0%>
    <%test.testQutions.forEach(function(qution){%>
    <%i++%>
    <div class="qution" id="qution<%=i%>">

        <%if(qution.type=='選擇題'){%>
        <p style="font-size: 20px">題目:
            <%=qution.qutionName%> （選擇題）
        </p>
        <div>
            <div class="row">
                <%let MCQindex = 0%>
                <%qution.selection.forEach(function(selection){%>
                  <div class="col-2"><input class="radioClick" onclick="onAnswer('MCQ','<%=i%>','<%=MCQindex%>')" type="radio">
                      <%=selection%>
                  </div>
                <%MCQindex+=1%>
                <%})%>

            </div>
            <br />
            <p>(配分:<%=qution.score%>)</p>
        </div>

        <%}%>

        <%if(qution.type=='是非題'){%>
        <p style="font-size: 20px">題目:
            <%=qution.qutionName%> （是非題）
        </p>
        <div>
            <div class="row">
                <div class="col-2"><input class="radioClick" name="textmode1" onclick="onAnswer('YNQ','<%=i%>','yes')" type="radio"> 是</div>
                <div class="col-2"><input class="radioClick" name="textmode1" onclick="onAnswer('YNQ','<%=i%>','no')" type="radio"> 否</div>
            </div>
            <br />
            <p>(配分:<%=qution.score%>)</p>
        </div>
        <%}%>

        <%if(qution.type=='填空題'){%>
        <p style="font-size: 20px">題目:
            <%=qution.qutionName%> （填空題）
        </p>
        <div>
            <div class="form-group row">
                <div class="col">
                    <label for="inputEmail3" class=" col-form-label">請輸入答案:</label>
                    <input type="text" id='FBQanswer<%=i%>' class="form-control" onkeyup="onAnswer('FBQ','<%=i%>','null')">
                </div>

            </div>
            <p>(配分:
                <%=qution.score%>)</p>
        </div>
        <%}%>

        <%if(qution.type=='程式題'){%>
        <p style="font-size: 20px">題目:
            <%=qution.qutionName%>（程式題）
        </p>
        <div>
            <p>輸入說明:
                <%=qution.inputDescription%>
            </p>
            <p>輸出說明:
                <%=qution.outputDescription%>
            </p>
            <div class="row">
                <div class="col ">
                    <pre>輸入範例：
<%=qution.inputExample%>
                    </pre>
                </div>
                <div class="col ">
                    <pre>輸出範例：
<%=qution.outputExample%>
                    </pre>
                </div>
            </div>
            <div class="row" style="height: 20rem">
                <div class="col">
                    <div class="md-form">
                        <textarea class="md-textarea form-control" style="height: 70%;" onclick="setCanTab(this)" id="code<%=i%>"></textarea>
                    </div>
                    <div class="md-form">
                        <textarea class="md-textarea form-control" onclick="setCanTab(this)" style="height: 20%;" id="input<%=i%>"></textarea>
                    </div>
                    <select id="language<%=i%>" class="mt-1">
                        <option value="cpp">c++</option>
                        <option value="c">c</option>
                        <option value="javascript">javascript</option>
                        <option value="python3">python</option>
                    </select>
                </div>
                <div class="col">
                    <div class="md-form">
                        <div class="md-textarea form-control" style="height: 90%;">
                            <pre id="output<%=i%>"></pre>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-1 float-right" onclick="onAnswer('PGQ','<%=i%>','null');compile(<%=i%>);">編譯</button>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <p>(配分:<%=qution.score%>)
                    </p>
                </div>
            </div>

        </div>
        <%}%>
    </div>

    <%})%>
    <%if(user.permission == 'student'){%>
    <%if(isSubmited == false){%>
    <button class="btn btn-primary float-right" onclick="finishTest()">送出</button>
    <%}%>

    <%}%>
</div>




</div>
<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<script>
    let answerArray = [];
    $('input[type=radio]').click(function(){
        if (this.previous) {
            this.checked = false;
        }
        this.previous = this.checked;
    });
    let onAnswer = function (qutionType, qutionNumber, answer) {
        console.log(qutionType,answer,qutionNumber);
        // console.log(qutionType + ' ' + answer + ' ' + qutionNumber);
        if (qutionType == 'MCQ') {
            console.log(qutionNumber);
            if(answerArray[qutionNumber-1]==undefined){
              answerArray[qutionNumber-1] = {studentAnswer:[]}
              answerArray[qutionNumber-1].studentAnswer[answer]="1"
            }else{
              if(answerArray[qutionNumber-1].studentAnswer[answer]==="1"){
                  answerArray[qutionNumber-1].studentAnswer[answer]="0";
              }else{
                  answerArray[qutionNumber-1].studentAnswer[answer]="1";
              }
            }
        }
        if (qutionType == 'YNQ') {
          if(answerArray[qutionNumber-1]==undefined){
            answerArray[qutionNumber-1] = {studentAnswer:""}
            answerArray[qutionNumber-1].studentAnswer=answer
          }else{
            answerArray[qutionNumber-1].studentAnswer=answer
          }
        }
        if (qutionType == 'FBQ') {
          let answerText = document.getElementById('FBQanswer'+qutionNumber).value;
          if(answerArray[qutionNumber-1]==undefined){
            answerArray[qutionNumber-1] = {studentAnswer:""}
            answerArray[qutionNumber-1].studentAnswer=answerText
          }else{
            answerArray[qutionNumber-1].studentAnswer=answerText
          }
        }
        if (qutionType == 'PGQ') {
          let code = document.getElementById('code'+qutionNumber).value;
          let language =document.getElementById('language'+qutionNumber).value;
          if(answerArray[qutionNumber-1]==undefined){
            answerArray[qutionNumber-1] = {studentAnswer:"",language:""}
            answerArray[qutionNumber-1].studentAnswer=code
            answerArray[qutionNumber-1].language = language
          }else{
            answerArray[qutionNumber-1].studentAnswer=code;
            answerArray[qutionNumber-1].language = language
          }
        }
        console.log(answerArray);

    }

    let compile = function (qutionNumber) {
        console.log(qutionNumber);
        let script = document.getElementById('code' + qutionNumber);
        let input = document.getElementById('input' + qutionNumber);
        let language = document.getElementById('language' + qutionNumber);
        let output = document.getElementById('output' + qutionNumber);
        var scriptData = {
            input: input.value,
            script: script.value,
            language: language.value,
            id: "001"
        }

        var socket = io();
        socket.emit('script', scriptData);
        output.innerHTML = "編譯中....\n";
        socket.on('answer', function (obj) {
            console.log(obj);
            output.innerHTML = "輸出:\n" + obj.body.output;

            // //記錄到答案中
            // onAnswer('PGQ', {
            //     scriptData: scriptData,
            //     output: obj.body.output
            // }, qutionNumber);
        });
        //為了讓textarea - script 按下tab的時候不會自己切去另一個textarea
        script.onkeydown = function (e) {
            if (e.keyCode == 9) {
                insertAtCursor('    ');
                return false;
            }
        }
    }

    let setCanTab = function (script) {
        script.onkeydown = function (e) {
            if (e.keyCode == 9) {
                insertAtCursor2('    ', script);
                return false;
            }
        }
    }

    function insertAtCursor2(myValue, field) {
        myField = field;
        //IE support
        if (document.selection) {
            myField.focus();
            sel = document.selection.createRange();
            sel.text = myValue;
        }
        //MOZILLA and others
        else if (myField.selectionStart || myField.selectionStart == '0') {
            var startPos = myField.selectionStart;
            var endPos = myField.selectionEnd;
            myField.value = myField.value.substring(0, startPos) +
                myValue +
                myField.value.substring(endPos, myField.value.length);
            myField.selectionStart = startPos + myValue.length;
            myField.selectionEnd = startPos + myValue.length;
        } else {
            myField.value += myValue;
        }
    }
    let finishTest = function () {
        let qutions = <%- JSON.stringify(test) %>
        for (let i = 0; i < qutions.testQutions.length; i++) {
            if(qutions.testQutions[i].type=="程式題"){
                qutions.testQutions[i].studentAnswer = answerArray[i].studentAnswer
                qutions.testQutions[i].language = answerArray[i].language
            }else{
                qutions.testQutions[i].studentAnswer = answerArray[i].studentAnswer
            }
        }
        qutions.writer = "<%=user._id%>"
        console.log(qutions);
        $.ajax({
            url: '/SDC/submitTest',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(qutions),
            dataType: 'json',
            error: function (xhr) {
                alert('發生錯誤');
            },
            success: function (response) {
                alert('填寫測驗成功');
                window.location = "/class/<%=classinfo._id%>/showUnit/<%=test.belongUnit%>"
            }
        })
    }
</script>

<% include layout/footer %>
