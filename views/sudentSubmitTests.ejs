<% include layout/header %>


<style>
    .list-group-item .fa {
        margin-right: 5px;
    }

    /* 文字超過自動省略成... */
    .ellipsisText {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: inherit;

    }
    .alert:hover {
        background: rgb(228, 227, 225);
    }

    .unit {
        width: 100%;
        text-align: center;
        padding: 1rem;
        background: rgb(88, 175, 164);
        color: rgb(90, 88, 88);
        border-radius: 25px;
    }

    .test {
        width: 100%;
        text-align: center;
        padding: 0.6rem;
        background: rgb(102, 172, 129);
        color: rgb(255, 255, 255);
        border-radius: 25px;
    }

    a {
        text-decoration: none;
    }

    a:hover {
        text-decoration: none;
    }
    .studentList{
        width: 100%;
        padding: 0.6rem;
        text-align: center;
        list-style: none;
        margin-bottom: 0.6rem
    }

    .studentUl{
        width: 100%;
        padding: 0;
        height: 35rem;
        overflow-y: scroll;
    }
    .qution{
        margin-bottom: 2rem;
        padding: 20px;
        border-radius:20px;
        background-color:rgb(255, 255, 255);
        border: 1px solid rgb(194, 190, 190);
    }
    .qution:hover {
        box-shadow: 0px 0px 10px rgb(180, 198, 235);
        border: 1px solid rgba(93, 143, 246, 1);
        z-index: 2;
        -webkit-transition: all 200ms ease-in;
        -webkit-transform: scale(1.005);
        -ms-transition: all 200ms ease-in;
        -ms-transform: scale(1.005);
        -moz-transition: all 200ms ease-in;
        -moz-transform: scale(1.005);
        transition: all 200ms ease-in;
        transform: scale(1.005);
    }
    .space {
        display: flex;
        margin-bottom: 1rem
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.2/css/all.min.css">

<a href="/class/<%=classinfo._id%>"><i class="fas fa-arrow-left" style="padding:1rem 0;color:rgb(180, 211, 172)"> 回課程資訊頁面</i></a>

<h3>學習狀況</h3>
<hr>
<div class="row">
    <!-- 左邊的匡 -->
    <div class="col-lg-3 col-sm-12">
        <div class="row">
            <div class="dropdown w-100">
                <div class="space">
                    <label class="col-sm-4 col-form-label">選擇單元</label>
                    <div class="col-sm-8" style="padding-right:0px;">
                        <select id="selectUnit" class="form-control"  onchange="onchangeUnit(this.value)">

                        </select>
                    </div>
                </div>
                <div class="space">
                    <label class="col-sm-4 col-form-label">選擇測驗</label>
                    <div class="col-sm-8" style="padding-right:0px;">
                        <select id="selectQuiz" class="form-control" onchange="onchangeQuiz(this.value)">

                        </select>
                    </div>
                </div>
                <div class=" p-1 mb-0 pb-0" style="border: 0.3px solid rgb(192, 192, 192); margin-top:1rem; margin-left: 1rem;">
                      <ul class="studentUl" id="studentList">

                      </ul>
                </div>
            </div>
        </div>

    </div>


    <!-- 右邊的匡 -->
    <div class="col-lg-9 col-sm-12" id='leftbox'>

    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
    <script>
        var units = <%- JSON.stringify(units) %>;
        let tests = <%- JSON.stringify(tests) %>;
        let studentSubmits = <%-JSON.stringify(submits)%>
        let submiter = <%-JSON.stringify(submiter)%>
        let nowUnit;
        let nowE;
        let nowSubmiterName;
        let nowStudent;
        let nowTest;

        let getScore;
        let totalScore;

        let onchangeUnit = function (unitId) {
            let i;
            nowUnit = unitId;
            selectQuiz.length = 0;
            let testLength = 0;
            let rightbox = document.getElementById('leftbox');
            rightbox.innerHTML='';
            for (i = 0; i < tests.length; i++) {
                if (tests[i].belongUnit == nowUnit) {
                    if (testLength == 0) nowTest = tests[i]._id;
                    selectQuiz.options[testLength++] = new Option(tests[i].testName, tests[i]._id); // 設定新選項
                }
            }
            if(testLength==0){
                let rightbox = document.getElementById('leftbox');
                rightbox.innerHTML='';
                let alertDiv = document.createElement('div');
                alertDiv.innerHTML='此單元尚未建立測驗';
                alertDiv.style='text-align:center; margin-top:10px;';
                alertDiv.className='col-sm-12 alert alert-danger';
                rightbox.appendChild(alertDiv);
                studentList.innerHTML='';
            }else{
                onchangeQuiz(nowTest);
            }
            selectQuiz.length = testLength; // 刪除多餘的選項
        }
        let onchangeQuiz = function (quizId) {
            nowTest = quizId;
            let canCheckQuestionAndAnswer = ""
            let publishScoreNow = ""

            let rightbox = document.getElementById('leftbox');
            rightbox.innerHTML='';
            for (i = 0; i < tests.length; i++) {
                if (tests[i]._id == nowTest) {
                    canCheckQuestionAndAnswer = tests[i].canCheckQuestionAndAnswer
                    publishScoreNow = tests[i].publishScoreNow
                }
            }
            showSubmiter(nowTest);

        }

        let showSubmiter = function (testID) {
            nowTest = testID;
            studentList.innerHTML = '';
            let totalSubmitter = 0;
            for (let i = 0; i < studentSubmits.length; i++) {
                let submiterName = ''
                for (let j = 0; j < submiter.length; j++) {
                    if (submiter[j]._id == studentSubmits[i].writer) {
                        if (studentSubmits[i].testID == testID) {
                            totalSubmitter++;
                            submiterName = submiter[j].name;
                            studentList.innerHTML +=
                                `<li class="studentList" onclick ="showSubmiterAnswer('${submiter[j]._id}','${testID}','${submiter[j].name}',this)">${submiterName}</li>`
                        }
                    }
                }
            }

            if(totalSubmitter == 0){
                studentList.innerHTML = "<p class='col-sm-12 alert alert-danger' style ='text-align:center;'>還沒有人提交測驗喔!</p>"

            }
        }
        let showSubmiter2 = function (testID, e) {
            //console.log("e = " + e);

            nowTest = testID;
            studentList.innerHTML = '';
            let leftbox = document.getElementById('leftbox');
            leftbox.innerHTML = '';
            let testList = document.getElementById('testList');
            //console.log("testList.children.length = " + testList.children.length);

            for (let i = 0; i < testList.children.length; i++) {
                if (i == e) {
                    //console.log("match");
                    //console.log(testList.children[i]);
                    testList.children[i].style.cssText = "background:rgb(193, 190, 190)";
                } else {
                    testList.children[i].style.cssText = "background:rgb(150, 216, 168)";
                }
            }
            for (let i = 0; i < studentSubmits.length; i++) {
                let submiterName = ''
                for (let j = 0; j < submiter.length; j++) {
                    if (submiter[j]._id == studentSubmits[i].writer) {
                        if (studentSubmits[i].testID == testID) {
                            submiterName = submiter[j].name;
                            studentList.innerHTML +=
                                `<li class="studentList" onclick ="showSubmiterAnswer('${submiter[j]._id}','${testID}','${submiter[j].name}',this)">${submiterName}</li>`
                        }
                    }
                }
            }
        }

        let showSubmiterAnswer = function (submiterID, testID, submiterName, e) {
            nowStudent = submiterID;
            nowSubmiterName = submiterName;
            let studentList = document.getElementById('studentList');
            for (let i = 0; i < studentList.children.length; i++) {
                studentList.children[i].style.cssText = "background:white";
            }
            e.style.cssText = "background:rgb(194, 190, 190)";
            //console.log("-------------start--------------");
            let leftbox = document.getElementById('leftbox');
            let bightml = ''
            let test;
            for (let i = 0; i < studentSubmits.length; i++) {
                if (studentSubmits[i].writer == submiterID) {
                    if (studentSubmits[i].testID == testID) {
                        test = studentSubmits[i];
                    }
                }
            }
            totalScore = 0;
            if (test.score) {
                getScore = parseInt(test.score);
            } else {
                getScore = 0;
            }

            for (let i = 0; i < test.testQutionsAndAnswer.length; i++) {
                totalScore += parseInt(test.testQutionsAndAnswer[i].score);
            }
            //console.log("totoal score = " + totalScore);
            let msg = "未批閱"
            let color = "warning"
            if (test.isTeacherMarked) {
                msg = "已批閱"
                color = "success"
            }

            bightml +=
                `
            <div class="row">
                <div class="col" style="padding:12px"><h5>答題者：${submiterName}</h5></div>
                <div class="col">
                    <p class="alert alert-${color} text-center" id = "status" role="alert">
                    ${msg}
                    </p>
                </div>

                <div class="col text-right" style="padding:12px"><h5 id="scoreField">得分:</h5></div>
            </div>
            `;
            for (let i = 0; i < test.testQutionsAndAnswer.length; i++) {
                let qution = test.testQutionsAndAnswer[i];
                console.log(qution);

                let html =
                    `
                    <div class="qution" id="qution${i}">
                    `
                if (qution.type == '選擇題') {
                    if (test.isTeacherMarked) {
                        if (test.markArray[i] == 'right') {
                            html +=
                                `
                            <div style="font-size: 20px; color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(選擇題）</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(選擇題）</p>
                            </div>`
                        }
                    } else {
                        //判斷答案是否正確
                        let studentAnswers = [];
                        for(let i = 0;i<qution.selection.length;i++){
                            //console.log("i = "+qution.studentAnswer[i]);
                            if(qution.studentAnswer[i]=="1"){
                                studentAnswers.push(qution.selection[i]);
                            }
                        }
                        //console.log(studentAnswers);
                        let isCorrect = true;
                        //console.log(studentAnswers.length,qution.correctAnswers.length);

                        if(studentAnswers.length!=qution.correctAnswers.length){
                            isCorrect=false;
                        }
                        //console.log(isCorrect);

                        for(let i =0;i<qution.correctAnswers.length;i++){
                            //console.log(studentAnswers.indexOf(qution.correctAnswers[i]));
                            if(studentAnswers.indexOf(qution.correctAnswers[i])===-1){
                                isCorrect=false;
                            }
                        }
                        if (isCorrect) {
                            getScore += parseInt(qution.score);
                            html +=
                                `
                            <div style="font-size: 20px; color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(選擇題）</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(選擇題）</p>
                            </div>`
                        }
                    }
                    let selection = "";
                    for(let i = 0;i<qution.selection.length;i++){
                      if(qution.studentAnswer[i]=="1"){
                        selection+=`
                        <div class="col-12"><input  checked type="radio">
                          ${qution.selection[i]}
                        </div>
                        `
                      }else{
                        selection+=`
                        <div class="col-12"><input  type="radio">
                          ${qution.selection[i]}
                        </div>
                        `
                      }
                    }
                    html +=
                        `
                    <p>學生答案:</p>
                    <div>
                        <div class="row">
                            ${selection}
                        </div>
                        <br />
                        <p>正確答案：${qution.correctAnswers}</p>
                        <p>(配分:
                            ${qution.score})
                        </p>
                        <div class="row">
                            <div class="col">
                                <button class="btn btn-success float-right" onclick = "changeCorrection(true,${i},'${qution.score}')">正確</button>
                                <button class="btn btn-danger float-right mr-1" onclick = "changeCorrection(false,${i},'${qution.score}')">不正確</button>
                            </div>
                        </div>
                    </div>
                    `
                }
                if (qution.type == '是非題') {
                    let yes = '';
                    if (qution.studentAnswer == 'yes') {
                        yes = "checked";
                    }
                    let no = '';
                    if (qution.studentAnswer == 'no') {
                        no = "checked";
                    }
                    if (test.isTeacherMarked) {
                        if (test.markArray[i] == 'right') {
                            html +=
                                `
                            <div style="font-size: 20px; color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(是非題）</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(是非題）</p>
                            </div>`
                        }
                    } else {
                        if (qution.studentAnswer == qution.correctAnswers) {
                            getScore += parseInt(qution.score);
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(是非題）</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(是非題）</p>
                            </div>`
                        }
                    }

                    html +=
                        `
                <p>學生答案:</p>
                <div>
                    <div class="row">
                        <div class="col-2"><input name="textmode${i}" ${yes} onclick="onAnswer('YNQ','yes','${i}')" type="radio"> yes</div>
                        <div class="col-2"><input name="textmode${i}" ${no} onclick="onAnswer('YNQ','no','${i}')" type="radio"> no</div>
                    </div>
                    <br />
                    <p>正確答案：${qution.correctAnswers}</p>
                    <p>(配分:
                        ${qution.score})
                    </p>
                    <div class="row">
                        <div class="col">
                            <button class="btn btn-success float-right" onclick = "changeCorrection(true,${i},'${qution.score}')">正確</button>
                            <button class="btn btn-danger float-right mr-1" onclick = "changeCorrection(false,${i},'${qution.score}')">不正確</button>
                        </div>
                    </div>
                </div>
        `
                }

                if (qution.type == '填空題') {
                    if (test.isTeacherMarked) {
                        if (test.markArray[i] == 'right') {
                            html +=
                                `
                            <div style="font-size: 20px; color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(填空題)</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(填空題)</p>
                            </div>`
                        }
                    } else {
                        let isCorrect = false;
                        for(let i = 0;i<qution.correctAnswers.length;i++){
                          if(qution.studentAnswer == qution.correctAnswers[i]){
                            isCorrect = true;
                          }
                        }
                        if (isCorrect) {
                            getScore += parseInt(qution.score);
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(填空題)</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;" id ="title${i}"class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(填空題)</p>
                            </div>`
                        }
                    }

                    html +=
                        `
                    <p>學生答案:</p>
                    <div>
                        <div class="form-group row">
                            <div class="col">
                                <pre>${qution.studentAnswer}</pre>
                            </div>

                        </div>

                        <p>正確答案：${qution.correctAnswers}</p>
                        <p>(配分:
                            ${qution.score})
                        </p>
                        <div class="row">
                            <div class="col">
                                <button class="btn btn-success float-right" onclick = "changeCorrection(true,${i},'${qution.score}')">正確</button>
                                <button class="btn btn-danger float-right mr-1" onclick = "changeCorrection(false,${i},'${qution.score}')">不正確</button>
                            </div>
                        </div>
                    </div>
                    `
                }

                if (qution.type == '程式題') {
                    if (qution.userAnswer == '' || qution.userAnswer == undefined) {
                        qution.userAnswer = {
                            scriptData: {
                                language: '未填寫',
                                script: '未填寫',
                                input: '未填寫'

                            },
                            output: "未填寫"

                        }

                    }
                    let languageValue = ''
                    switch (qution.userAnswer.scriptData.language) {
                        case 'python3':
                            languageValue = 'python3'
                            break;
                        case 'c++':
                            languageValue = 'cpp'
                            break;

                        case 'c':
                            languageValue = 'c'
                            break;
                        case 'javascript':
                            languageValue = 'javascript'
                            break;
                        default:
                            break;
                    }

                    if (test.isTeacherMarked) {
                        if (test.markArray[i] == 'right') {
                            html +=
                                `
                            <div style="font-size: 20px; color:white;border-radius: 5px;"id ="title${i}" class="bg-success p-1">
                                <pre style="color:white"><i class="fas fa-check mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(程式題)</p>
                            </div>`
                        } else {
                            html +=
                                `
                            <div style="font-size: 20px;color:white;border-radius: 5px;"id ="title${i}" class="bg-danger p-1">
                                <pre style="color:white"><i class="fas fa-times mr-1"></i>題目:${qution.qutionName} </pre>
                                <p style="color:white">(程式題)</p>
                            </div>`
                        }
                    } else {
                        //console.log("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFf");
                        let isCorrect = false;
                        var testverification = {
                          input: qution.intputTest,
                          script: qution.studentAnswer,
                          language: qution.language,
                          id: "001"
                        }
                        var socket = io();
                        socket.emit('script', testverification);
                        socket.on('answer', function (obj) {
                            console.log(obj);
                            // console.log(obj.body.output);
                            // console.log(qution.language);
                            obj.body.output = obj.body.output.substring(0,obj.body.output.length-1)
                            if(obj.body.output == qution.outputTest){
                                isCorrect = true
                                changeCorrection1(isCorrect,i,qution.score)
                            }else{
                                changeCorrection1(isCorrect,i,qution.score)
                            }
                        });
                        html +=
                            `
                        <div style="font-size: 20px" id ="title${i}">
                            <pre style="color:white">題目:${qution.qutionName} </pre>
                            <p style="color:white">(程式題)</p>
                        </div>`
                    }
                    html +=
                        `
                    <p>學生答案:</p>
                    <div>
                        <p>輸入說明:
                                ${qution.inputDescription}
                        </p>
                        <p>輸出說明:
                            ${qution.outputDescription}
                        </p>
                        <div class="row">
                            <div class="col ">
                                <pre>輸入範例：
${qution.inputExample}
                                </pre>
                            </div>
                            <div class="col ">
                                <pre>輸出範例：
${qution.outputExample}
                                </pre>
                            </div>
                        </div>
                        <div class="row" style="height: 20rem">
                            <div class="col">
                                <div class="md-form">
                                    <textarea class="md-textarea form-control" style="height: 70%;" onclick="setCanTab(this)" id="code${i}">${qution.studentAnswer}</textarea>
                                </div>
                                <div class="md-form">
                                    <textarea class="md-textarea form-control" onclick="setCanTab(this)" style="height: 20%;" id="input${i}"></textarea>
                                </div>
                                <select id="language${i}" class="mt-1" >
                                    <option value="${qution.language}">${qution.language}</option>
                                </select>
                            </div>
                            <div class="col" style="overflow:hidden">
                                <div class="md-form">
                                    <div class="md-textarea form-control" style="height: 90%;">
                                        <pre id="output${i}" class="h-100">${qution.userAnswer.output}
                                        </pre>
                                    </div>
                                </div>
                                <button class="btn btn-primary mt-1 float-right" onclick="compile(${i})">編譯</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <p>(配分:
                                        ${qution.score})
                                </p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <button class="btn btn-success float-right" onclick = "changeCorrection(true,${i},'${qution.qutionName}','${qution.score}')">正確</button>
                                <button class="btn btn-danger float-right mr-1" onclick = "changeCorrection(false,${i},'${qution.qutionName}','${qution.score}')">不正確</button>
                            </div>
                        </div>

                </div>
                `
                }
                html += `</div>`
                bightml += html;
            }
            bightml +=
                `<div class="row">
                <div class="col">
                    <button class="btn btn-success float-right" onclick = saveMark("${submiterID}","${testID}","${test.testQutionsAndAnswer.length}")>儲存批閱結果</button>
                </div>
                </div>`
            leftbox.innerHTML = bightml;
            let scoreField = document.getElementById('scoreField');
            if (test.isTeacherMarked) {
                scoreField.innerHTML = `得分:${test.score}/${totalScore}`
            } else {
                scoreField.innerHTML = `得分:${getScore}/${totalScore}`
            }

        }

        let saveMark = function (submiterID, testID, qutionlength) {
            //console.log(submiterID, testID, qutionlength);
            let notMarkedQutionNumber = 0;
            let markArray = []
            for (let i = 0; i < qutionlength; i++) {
                let title = document.getElementById('title' + i);
                if (title.className == '') {
                    notMarkedQutionNumber++;
                    markArray[i] = 'notMarkyet'
                }
                if (title.className == 'bg-success p-1') {
                    markArray[i] = 'right'
                }
                if (title.className == 'bg-danger p-1') {
                    markArray[i] = 'wrong'
                }
            }
            // console.log(notMarkedQutionNumber);
            console.log(markArray);
            if (notMarkedQutionNumber > 0) {
                alert('還有' + notMarkedQutionNumber + '題題目沒改完喔！')
            } else {
                let data = {
                    markArray: markArray,
                    score: getScore
                }
                $.ajax({
                    url: '/class/saveMark/' + testID + '/' + submiterID,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    dataType: 'json',
                    success: function (response) {
                        alert('儲存成功');
                        // console.log("nowUnit = ");
                        // console.log(nowUnit);

                        localStorage.setItem("nowUnit", nowUnit.outerHTML);
                        localStorage.setItem("nowE", nowE);
                        localStorage.setItem("nowSubmiterName", nowSubmiterName);
                        localStorage.setItem("nowStudent", nowStudent);
                        localStorage.setItem("nowTest", nowTest);

                        location.reload();
                    },
                    error: function (err) {
                        alert('錯誤訊息：' + err);
                    }
                });
            }

        }


        let changeCorrection = function (isCorrect, qutionNumber, score) {
            let title = document.getElementById('title' + qutionNumber);
            let titletext = "";
            for(let i =0;i<tests.length;i++){
                if(tests[i]._id == nowTest){
                    titletext = tests[i].testQutions[qutionNumber].qutionName;
                    break;
                }
            }
            console.log(titletext);

            if (isCorrect) {
                title.style.cssText = "font-size: 20px;color:white;border-radius: 5px;";
                if (title.className == '' || title.className == "bg-danger p-1") {
                    getScore += parseInt(score);
                }
                title.className = "bg-success p-1";
                title.innerHTML = '';
                title.innerHTML = `<i class="fas fa-check mr-1 pr-1 pl-1"style="width:2rem"></i>題目：` + titletext +
                    ' (程式題)'
            } else {
                title.style.cssText = "font-size: 20px;color:white;border-radius: 5px;";
                if (title.className == "bg-success p-1") {
                    getScore -= parseInt(score);
                }
                title.className = "bg-danger p-1";
                title.innerHTML = '';
                title.innerHTML = `<i class="fas fa-times mr-1  pl-2" style="width:2rem"></i>題目：` + titletext +
                    ' (程式題)'
            }
            let scoreField = document.getElementById('scoreField');
            scoreField.innerHTML = `得分:${getScore}/${totalScore}`

        }
        let changeCorrection1 = function (isCorrect, qutionNumber, score) {
            let title = document.getElementById('title' + qutionNumber);
            let titletext = "";
            for(let i =0;i<tests.length;i++){
                if(tests[i]._id == nowTest){
                    titletext = tests[i].testQutions[qutionNumber].qutionName;
                    break;
                }
            }
            if (isCorrect) {
                title.style.cssText = "font-size: 20px;color:white;border-radius: 5px;";
                if (title.className == '' || title.className == "bg-danger p-1") {
                    getScore += parseInt(score);
                }
                title.className = "bg-success p-1";
                title.innerHTML = '';
                title.innerHTML = `<i class="fas fa-check mr-1 pr-1 pl-1"style="width:2rem"></i>題目：` + titletext +
                    ' (程式題)'
            } else {
                title.style.cssText = "font-size: 20px;color:white;border-radius: 5px;";
                if (title.className == "bg-success p-1") {
                    getScore -= parseInt(score);
                }
                title.className = "bg-danger p-1";
                title.innerHTML = '';
                title.innerHTML = `<i class="fas fa-times mr-1  pl-2" style="width:2rem"></i>題目：` + titletext +
                    ' (程式題)'
            }
            let scoreField = document.getElementById('scoreField');
            scoreField.innerHTML = `得分:${getScore}/${totalScore}`

        }
        let compile = function (qutionNumber) {
            //console.log(qutionNumber);
            let script = document.getElementById('code' + qutionNumber);
            let input = document.getElementById('input' + qutionNumber);
            let language = document.getElementById('language' + qutionNumber);
            let output = document.getElementById('output' + qutionNumber);
            var scriptData = {
                input: input.value,
                script: script.value,
                language: language.value,
                id: "001"
            }
            //console.log(scriptData);

            var socket = io();
            socket.emit('script', scriptData);
            output.innerHTML = "編譯中....\n";
            socket.on('answer', function (obj) {
                //console.log(obj);
                output.innerHTML = "輸出:\n" + obj.body.output;

                //記錄到答案中
                // onAnswer('PGQ', {
                //     scriptData: scriptData,
                //     output: obj.body.output
                // }, qutionNumber);
            });
            //為了讓textarea - script 按下tab的時候不會自己切去另一個textarea
            script.onkeydown = function (e) {
                if (e.keyCode == 9) {
                    insertAtCursor('    ');
                    return false;
                }
            }
        }


        window.onload = function () {
            nowUnit = localStorage.getItem("nowUnit");
            nowE = localStorage.getItem("nowE");
            nowSubmiterName = localStorage.getItem("nowSubmiterName");
            nowStudent = localStorage.getItem("nowStudent");
            nowTest = localStorage.getItem("nowTest");

            /*if (nowUnit != undefined && nowE != undefined && nowSubmiterName != undefined && nowStudent !=
                undefined && nowTest != undefined) {
                nowUnit = new DOMParser().parseFromString(nowUnit, "text/xml").firstChild;
                // nowE = new DOMParser().parseFromString(nowE, "text/xml").firstChild;
                nowUnitID = nowUnit.getAttribute('unitid');
                nowUnitName = nowUnit.getAttribute('unitname');
                showTestInUnit2(nowUnitID, nowUnitName);
                // console.log("nowE = ");
                // console.log(nowE);
                showSubmiter2(nowTest, nowE);
            }*/

            let i;
            for (i = 0; i < units.length; i++) {
                if (i == 0) {
                    nowUnit = units[i]._id;
                }
                selectUnit.options[i] = new Option(units[i].unitName, units[i]._id);
            }
            selectQuiz.length = 0;
            let testLength = 0;
            for (i = 0; i < tests.length; i++) {
                if (tests[i].belongUnit == nowUnit) {
                    if (testLength == 0) nowTest = tests[i]._id;
                    selectQuiz.options[testLength++] = new Option(tests[i].testName, tests[i]._id);
                }
            }
            if(testLength==0){
                let rightbox = document.getElementById('leftbox');
                rightbox.innerHTML='';
                let alertDiv = document.createElement('div');
                alertDiv.innerHTML='此單元尚未建立測驗';
                alertDiv.style='text-align:center; margin-top:10px;';
                alertDiv.className='col-sm-12 alert alert-danger';
                rightbox.appendChild(alertDiv);
            }else{
                onchangeQuiz(nowTest);
            }
            selectQuiz.length = testLength;



            let showDataBtn = document.getElementById('showDataBtn');
            showDataBtn.onclick = function () {
                let leftbox = document.getElementById('leftbox');
                //先看有幾題 就要加多少個canvas進去
                let testData; //這張考卷的資料
                for (let i = 0; i < tests.length; i++) {
                    if (tests[i]._id == nowTest) {
                        testData = tests[i]
                    }
                }
                let qutionlength = testData.testQutions.length; //這張考卷有幾題
                //console.log(testData);

                //再把所有有寫這份考卷並改過的考卷找進來
                let studentAnswers = []; //這份考卷所有學生的回答
                for (let i = 0; i < studentSubmits.length; i++) {
                    if (studentSubmits[i].testID == nowTest && studentSubmits[i].isTeacherMarked == true) {
                        studentAnswers.push(studentSubmits[i]);
                    }
                }
                if (studentAnswers.length == 0) {
                    alert('你還沒有改過任何一張考卷喔！')
                }
                sendforchatData = [];
                class dataobject {
                    constructor() {
                        this.title = ''
                        this.label = ''
                        this.data = ''
                    }
                }
                // console.log(studentAnswers);
                // console.log(qutionlength);
                //把題目放進去
                for (let i = 0; i < qutionlength; i++) {
                    console.log(testData.testQutions[i].title);
                    sendforchatData[i] = new dataobject();
                    sendforchatData[i].title = testData.testQutions[i].title;
                }
                //把統計的數字放到data
                //console.log("student submit data");

                let b = [];
                let eachQutionAnswers = [];
                for (let i = 0; i < studentAnswers.length; i++) {
                    //console.log(studentAnswers[i]);
                    for (let j = 0; j < studentAnswers[i].markArray.length; j++) {
                        //console.log(studentAnswers[i].markArray[j]);
                        b.push(studentAnswers[j].markArray[i])
                    }
                    let right = 0;
                    let wrong = 0;
                    for (let k = 0; k < b.length; k++) {
                        if (b[k] == 'right') {
                            right += 1;
                        }
                        if (b[k] == "wrong") {
                            wrong += 1;
                        }
                    }
                    eachQutionAnswers[i] = [right, wrong];
                    b = [];
                }
                // console.log("eachQutionAnswers ==");
                // console.log(eachQutionAnswers);




                //先清空leftbox
                leftbox.innerHTML = '';
                //加title
                leftbox.innerHTML = '<h4 class ="text-center">測驗情形</h4>';
                let ctx = [];
                let myChart = []
                for (let i = 0; i < qutionlength; i++) {
                    leftbox.innerHTML +=
                        `
                        <div class="chart-container" style="position: relative; height:20vh; width:100%">
                            <canvas id="myChart${i}"></canvas>
                        </div>`;

                }
                for (let i = 0; i < qutionlength; i++) {
                    //console.log(testData[i]);

                    ctx[i] = document.getElementById("myChart" + i).getContext('2d');
                    myChart[i] = new Chart(ctx[i], {
                        type: 'horizontalBar',
                        data: {
                            labels: [" 正確", " 錯誤"],
                            datasets: [{
                                label: sendforchatData[i].title,
                                data: eachQutionAnswers[i],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255,99,132,1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        mirror: true,
                                    }
                                }],
                                xAxes: [{
                                    ticks: {
                                        beginAtZero: true,
                                        stepSize: 1
                                    }
                                }]
                            }
                        }
                    });

                }



            }
        };
    </script>


    <% include layout/footer %>
